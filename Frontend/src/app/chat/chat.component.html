<!-- Floating Chat Toggle Button -->
<button
  (click)="toggleChat()"
  class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition-all z-50"
  aria-label="Toggle Chat"
  style="touch-action: manipulation;"
>
  <span *ngIf="!isChatOpen">ğŸ’¬</span>
  <span *ngIf="isChatOpen">âŒ</span>
</button>

<!-- Chat Box -->
<div
  [@chatSlide]="isChatOpen ? 'open' : 'closed'"
  *ngIf="isChatOpen"
  class="fixed bottom-24 right-3 left-3 sm:right-6 sm:left-auto w-auto sm:w-full sm:max-w-md bg-white dark:bg-gray-900 rounded-2xl shadow-2xl flex flex-col h-[500px] border border-gray-200 dark:border-gray-700 overflow-hidden transition-all z-50"
>
  <!-- Header -->
  <div class="px-4 py-3 bg-blue-600 text-white text-lg font-semibold">
    AI Chat Assistant
  </div>

  <!-- Messages -->
  <div
    #messageContainer
    class="flex-1 overflow-y-auto bg-gray-100 dark:bg-gray-800 p-3 sm:p-4 space-y-3"
    style="scroll-behavior: smooth;"
  >
    <div *ngFor="let msg of messages">
      <div [ngClass]="msg.user === 'User' ? 'text-right' : 'text-left'">
        <div
          [ngClass]="{
            'inline-block px-4 py-2 rounded-xl max-w-xs break-words': true,
            'bg-blue-600 text-white': msg.user === 'User',
            'bg-gray-300 dark:bg-gray-700 text-black dark:text-white': msg.user === 'AI'
          }"
        >
          <strong>{{ msg.user }}:</strong>
          <ng-container *ngIf="msg.text === 'ğŸ¤– Typing...'; else normalText">
            <span class="typing-dots">Typing<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></span>
          </ng-container>
          <ng-template #normalText>
            {{ msg.text }}
          </ng-template>
        </div>
      </div>
    </div>
  </div>

  <!-- Input -->
  <div class="p-3 border-t border-gray-300 dark:border-gray-700 flex gap-2 items-end">
    <textarea
      [(ngModel)]="prompt"
      (keydown)="onKeyDown($event)"
      rows="1"
      placeholder="Type your message..."
      class="flex-1 p-2 resize-none rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
      style="max-height: 120px;"
    ></textarea>
    <button
      (click)="askQuestion()"
      class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl"
    >
      Send
    </button>
  </div>

  <!-- Token Info -->
  <div *ngIf="tokens > 0" class="px-3 pb-2 text-xs text-gray-500 dark:text-gray-400">
    Tokens used: {{ tokens }}
  </div>
</div>
