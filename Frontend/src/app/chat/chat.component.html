<!-- Floating Chat Toggle Button -->
<button
  (click)="toggleChat()"
  class="group fixed bottom-6 right-6 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white p-4 rounded-full shadow-2xl hover:shadow-purple-500/50 transition-all duration-300 z-50 transform hover:scale-110 hover:rotate-12"
  aria-label="Toggle Chat"
  style="touch-action: manipulation;"
>
  <lucide-icon *ngIf="!isChatOpen" [img]="MessageCircle" class="w-6 h-6 group-hover:animate-pulse"></lucide-icon>
  <lucide-icon *ngIf="isChatOpen" [img]="X" class="w-6 h-6"></lucide-icon>

  <!-- Notification Badge -->
  <span *ngIf="!isChatOpen" class="absolute -top-1 -right-1 flex h-5 w-5">
    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
    <span class="relative inline-flex rounded-full h-5 w-5 bg-green-500 items-center justify-center">
      <lucide-icon [img]="Sparkles" class="w-3 h-3 text-white"></lucide-icon>
    </span>
  </span>
</button>

<!-- Chat Box -->
<div
  [@chatSlide]="isChatOpen ? 'open' : 'closed'"
  *ngIf="isChatOpen"
  class="fixed bottom-24 right-3 left-3 sm:right-6 sm:left-auto w-auto sm:w-full sm:max-w-md bg-gradient-to-br from-slate-900 via-purple-900/50 to-slate-900 backdrop-blur-xl border border-purple-500/30 rounded-3xl shadow-2xl flex flex-col h-[600px] overflow-hidden transition-all z-50"
>
  <!-- Header -->
  <div class="px-6 py-4 bg-gradient-to-r from-blue-600/90 to-purple-600/90 backdrop-blur-sm text-white flex items-center gap-3 border-b border-purple-500/30">
    <div class="relative">
      <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-400 rounded-full flex items-center justify-center">
        <lucide-icon [img]="Sparkles" class="w-5 h-5 text-white"></lucide-icon>
      </div>
      <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-purple-900 rounded-full"></span>
    </div>
    <div class="flex-1">
      <h3 class="text-lg font-bold">AI Assistant</h3>
      <p class="text-xs text-blue-100">Online â€¢ Ready to help</p>
    </div>
  </div>

  <!-- Message display -->
  <div #messageContainer class="flex-1 overflow-y-auto p-5 space-y-4 bg-gradient-to-b from-slate-900/50 to-purple-900/30">
    <div *ngFor="let msg of messages" class="animate-fade-in">
      <div [ngClass]="msg.user === 'User' ? 'flex justify-end' : 'flex justify-start'">
        <div class="max-w-[85%] flex items-end gap-2" [ngClass]="msg.user === 'User' ? 'flex-row-reverse' : 'flex-row'">
          <!-- Avatar -->
          <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center"
               [ngClass]="msg.user === 'User' ? 'bg-gradient-to-br from-blue-500 to-purple-500' : 'bg-gradient-to-br from-purple-500 to-pink-500'">
            <span class="text-white text-xs font-bold">{{ msg.user === 'User' ? 'U' : 'AI' }}</span>
          </div>

          <!-- Message Bubble -->
          <div
            [ngClass]="{
              'px-4 py-3 rounded-2xl shadow-lg backdrop-blur-sm transition-all duration-300 hover:scale-105': true,
              'bg-gradient-to-br from-blue-600 to-purple-600 text-white rounded-br-sm': msg.user === 'User',
              'bg-white/10 backdrop-blur-lg border border-white/20 text-white rounded-bl-sm': msg.user === 'AI'
            }"
          >
            <ng-container *ngIf="msg.text === 'ðŸ¤– Typing...'; else normalText">
              <div class="flex items-center gap-2">
                <lucide-icon [img]="Sparkles" class="w-4 h-4 animate-spin"></lucide-icon>
                <span class="typing-dots">Thinking<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></span>
              </div>
            </ng-container>
            <ng-template #normalText>
              <p class="text-sm leading-relaxed break-words">{{ msg.text }}</p>
            </ng-template>
            <div class="text-xs opacity-70 mt-2">{{ msg.timestamp | date: 'shortTime' }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Input Section -->
  <div class="p-4 border-t border-purple-500/30 bg-slate-900/80 backdrop-blur-sm">
    <div class="flex gap-3 items-end">
      <textarea
        [(ngModel)]="prompt"
        (keydown)="onKeyDown($event)"
        (input)="autoResize($event)"
        rows="1"
        placeholder="Type your message..."
        class="flex-1 px-4 py-3 resize-none rounded-2xl border border-purple-500/30 text-sm bg-white/5 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-300"
      ></textarea>
      <button
        (click)="askQuestion()"
        class="group flex-shrink-0 w-12 h-12 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white rounded-2xl shadow-lg hover:shadow-purple-500/50 transition-all duration-300 flex items-center justify-center transform hover:scale-110"
        aria-label="Send message"
      >
        <lucide-icon [img]="Send" class="w-5 h-5 group-hover:translate-x-1 transition-transform duration-300"></lucide-icon>
      </button>
    </div>

    <!-- Footer Actions -->
    <div class="mt-3 flex items-center justify-between text-xs">
      <button
        (click)="clearChat()"
        class="group flex items-center gap-2 text-gray-400 hover:text-red-400 transition-colors duration-200"
      >
        <lucide-icon [img]="Trash2" class="w-4 h-4 group-hover:animate-bounce"></lucide-icon>
        <span>Clear Chat</span>
      </button>

      <div *ngIf="tokens > 0" class="flex items-center gap-2 text-purple-300">
        <div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
        <span>{{ tokens }} tokens</span>
      </div>
    </div>
  </div>
</div>
